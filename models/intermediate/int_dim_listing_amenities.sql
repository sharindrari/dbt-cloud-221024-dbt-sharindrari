SELECT LISTING_ID,
       AMENITIES,
       CHANGE_DATE AS EFFECTIVE_FROM,
       COALESCE(DATE_SUB(LEAD(CHANGE_DATE) OVER (PARTITION BY LISTING_ID ORDER BY CHANGE_DATE), INTERVAL 1 DAY), CURRENT_DATE) AS EFFECTIVE_TO
FROM {{ ref( "stg_amenities_changelog" ) }}
ORDER BY 1,2